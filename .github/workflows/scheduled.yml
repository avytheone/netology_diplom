name: Scheduled Build

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install UV
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        
    - name: Install dependencies
      run: |
        uv sync
        
    - name: Install Quarto
      uses: quarto-dev/quarto-action@v1
      with:
        version: 'latest'
        
    - name: Build all documents
      run: |
        uv run quarto render research.qmd --to html
        uv run quarto render research.qmd --to pdf
        uv run quarto render presentation.qmd --to html
        
    - name: Check data integrity
      run: |
        echo "=== Data integrity check ==="
        if [ -f cardio_train.csv ]; then
          wc -l cardio_train.csv
          head -1 cardio_train.csv
        else
          echo "Warning: cardio_train.csv not found"
        fi
        
    - name: Generate build report
      run: |
        echo "=== Build Report $(date) ===" > build-report.txt
        echo "Research HTML: $(ls -lh research.html 2>/dev/null || echo 'Not generated')" >> build-report.txt
        echo "Research PDF: $(ls -lh research.pdf 2>/dev/null || echo 'Not generated')" >> build-report.txt
        echo "Presentation: $(ls -lh presentation.html 2>/dev/null || echo 'Not generated')" >> build-report.txt
        echo "=== End Report ===" >> build-report.txt
        cat build-report.txt
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: scheduled-build-{{ github.run_number }}
        path: |
          research.html
          research.pdf
          presentation.html
          build-report.txt
        retention-days: 7